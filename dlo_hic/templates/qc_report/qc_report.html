<%def name="composition(step, qc_dict)">
    <div class="composition" id="${step}">
        <%
            total_key = 'total' if 'total' in qc_dict else 'all'
            total = qc_dict.pop(total_key)

            if step not in ["extract_PET"]:
                intra = int(qc_dict.pop("intra-chromosome"))
                long_range = int(qc_dict.pop("long-range"))
                qc_dict["intra-chromosome(long-range)"] = long_range
                qc_dict['intra-chromosome(short-range)'] = (intra - long_range)
            
        %>

        ${composition_table(qc_dict, total, step)}
        ${composition_piechart(qc_dict, total, step)}

        <p class="total-reads"> Total reads: ${total} </p>
    </div>
</%def>

<%def name="composition_table(qc_dict, total, step)">
    <table class="qc_table" id="${step}">
        <tr>
            <th></th>
            <th>Reads number</th>
            <th>Ratio</th>
        </tr>

        % for item, val in qc_dict.items():
            <%
                ratio = float(val)/float(total)
                ratio_str = "{:.2%}".format(ratio)
            %>
            <tr>
                <td>${item}</td>
                <td>${val}</td>
                <td>${ratio_str}</td>
            </tr>
        % endfor

    </table>
</%def>

<%def name="composition_piechart(qc_dict, total, step)">
    <%
        # Convert Python dict to JS objects Array literal.
        dataset = [{"item": item, "number": n} for item, n in qc_dict.items()]
        dataset = str(dataset)
    %>
    <div class="composition piechart" id="${step}">
    <script> 
        var w = 200,
            h = w
        var svg = d3.select("div.piechart#${step}")
                    .append("svg")
                    .attr("id", ${step})
                    .attr("width", w)
                    .attr("height", h)

        var total = ${total}
        var dataset = ${dataset}

        var pie = d3.pie()

        var outerRadius = w / 2
        var innerRadius = w / 4

        var arc = d3.arc()
            .innerRadius(innerRadius)
            .outerRadius(outerRadius)

        var arcs = svg.selectAll("svg#${step} g.arc")
                      .data(pie(dataset.map(function(d){return +d.number})))
                      .enter()
                      .append("g")
                      .attr("class", "arc")
                      .attr("transform", "translate(" + outerRadius + ", " + outerRadius + ")")

        var color = d3.scaleOrdinal(d3.schemeCategory10)

        arcs.append("path")
            .attr("fill", function(d, i) {
                return color(i)
            })
            .attr("d", arc)

        arcs.append("text")
            .attr("transform", function(d) {
                return "translate(" + arc.centroid(d) + ")"
            })
            .attr("text-anchor", "middle")
            .text(function(d) {
                return d.number
            })
            .attr("fill", "white")

    </script>
    </div>
</%def>

<%def name="reads_compositions(qc_contents)">
    <div class="reads_compositions">
        % for step, qc_dict in qc_contents.items():
        <h3>Step: ${step}</h3>
        <% step = step.replace(".", "_") %>
            <div class="reads_compositions">
                ${composition(step, qc_dict)}
            </div>
        % endfor
    </div>
</%def>

<html>
    <head>
       <style>
        <%include file="/qc_report.css" />
       </style>
       <script>
        <%include file="/d3.v4.min.js" />
       </script>
    </head>

    <body>
        <h1>DLO-HiC-Tools Quality Control Report</h1>

        <p class="sample-id">Sample: ${sample_id}</p>

        <div class="compositions">
            <h2>Reads compositions of each step's result</h2>
            ${reads_compositions(qc_contents)}
        </div>

        <div>
            <h2>Tendency</h2>
        </div>
    </body>

</html>